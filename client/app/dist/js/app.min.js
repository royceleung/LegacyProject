/*! app.js 2015-11-09 */
angular.module("myApp",["ngRoute","ngCookies","myApp.home"]).config(["$routeProvider",function(a){a.when("/home",{templateUrl:"home/home.html",controller:"homeController"}).otherwise({redirectTo:"/home"})}]).controller("mainController",["$scope","$cookies",function(a,b){a.fbCookie=!1;var c=b.get("facebook");if(c){c=c.split("j:"),c=JSON.parse(c[1]);var d={fbUserId:c.fbId,fbUserName:c.fbUserName,fbPicture:c.fbPicture};a.user=d,a.fbCookie=!0}}]),angular.module("myApp.home",["ngRoute","ngCookies"]).controller("homeController",["$scope","$log","$http","$cookies",function(a,b,c,d){a.map,a.userPosition,a.sitesResults,a.currentKeyword,a.clickedPosition,a.currentRankByFlag,a.checkins,a.allUsers=[],a.user,a.friendAdded=!1,a.theUser,a.notifications=!1,a.notificationCounter,a.sports={Basketball:"Basketball Court",Soccer:"Soccer Field",Tennis:"Tennis Court",Baseball:"Baseball Field",Softball:"Softball Field",Gym:"Gym","Rock-Climbing":"Climbing Gym",Golf:"Golf Course",Racquetball:"Racquetball Court",Squash:"Squash Court"};var e,f,g,h,i={lat:37.7833,lng:-122.4167},j="../assets/images/centerflag.png",k="../assets/images/bluedot.png",l={"Basketball Court":"../assets/images/basketball.png","Soccer Field":"../assets/images/soccer.png","Tennis Court":"../assets/images/tennis.png","Baseball Field":"../assets/images/baseball.png","Softball Field":"../assets/images/softball.png",Gym:"../assets/images/gym.png","Climbing Gym":"../assets/images/climbing.png","Golf Course":"../assets/images/golf.png","Racquetball Court":"../assets/images/racketball.png","Squash Court":"../assets/images/squash.png"},m=[];a.notificationChecker=function(){a.notificationCounter=a.theUser.inviteFriend.length+a.theUser.eventInvites.length,console.log(a.notificationCounter),a.notificationCounter>0?a.notifications=!0:a.notifications=!1},a.getAllUsers=function(){b=!1;var b=d.get("facebook");if(b){b=b.split("j:"),b=JSON.parse(b[1]);var e={fbUserId:b.fbId,fbUserName:b.fbUserName,fbPicture:b.fbPicture};a.user=e,a.fbCookie=!0,c.get("/getAllUsers").then(function(b){a.allUsers=b.data,console.log("allUsers",a.allUsers);for(var c=0;c<a.allUsers.length;c++)a.allUsers[c].friended=!1,a.allUsers[c].pending=!1,a.allUsers[c].username===a.user.fbUserName&&(a.theUser=a.allUsers[c]);for(var c=0;c<a.theUser.friends.length;c++)for(var d=0;d<a.allUsers.length;d++)a.theUser.friends[c]===a.allUsers[d].username&&(console.log("Found a friend"),a.allUsers[d].friended=!0);console.log("Friend Requests: ",a.theUser.inviteFriend.length),console.log("Event Invites:",a.theUser.eventInvites),a.notificationChecker()})}},a.addFriend=function(b){console.log("Adding as friend: ",b),a.theUser.username===b&&(a.theUser.inviteFriend.pop(),a.theUser.friends.push(b)),a.cancelFriendRequest(),c.post("/addFriend",{user:a.user,friend:b}).then(function(b){var c=b.data[b.data.length-1];console.log("added friend to database: ",c);for(var d=0;d<a.allUsers.length;d++)a.allUsers[d].username===c&&(a.allUsers[d].friended=!0,a.allUsers[d].pending=!1);a.notificationChecker()})},a.sendEvents=function(b){console.log("My friends",a.theUser.friends),c.post("sendEvent",{user:a.user.fbUserName,friends:a.theUser.friends,event:b}).then(function(b){console.log("Successfully sent friends this event",b),console.log("Before userInvite: ",a.theUser.eventInvites),a.theUser.username===b.data[b.data.length-1].sender&&(console.log("Am i in here"),a.theUser.eventInvites=b.data),a.notificationChecker()})},a.cancelFriendRequest=function(b){if(console.log("removing Friend Request"),b)for(var d=0;d<a.allUsers.length;d++)a.allUsers[d].username===b&&(a.allUsers[d].pending=!1);a.theUser.username===b&&a.theUser.inviteFriend.pop(),c.post("/removeFriendRequest",{user:a.user}).then(function(a){console.log("removed this person from friends list",a.data)})},a.friendRequest=function(b){console.log("requesting as friend: ",b);for(var d=0;d<a.allUsers.length;d++)a.allUsers[d].username===b&&(a.allUsers[d].pending=!0);c.post("/friendRequest",{user:a.user,friend:b}).then(function(c){var d=c.data.friendRequest;console.log("friendRequests in database",d),a.theUser.username===b&&(console.log("adding myself as a friend request"),a.theUser.inviteFriend=d),a.notificationChecker(),console.log("inviteFriend",a.theUser.inviteFriend)})},a.changeLocation=function(b){f=new google.maps.Geocoder,b=$("#location-search").val(),f.geocode({address:b},function(b,c){c==google.maps.GeocoderStatus.OK?(o(b[0].geometry.location,14),n(b[0].geometry.location),a.clickedPosition=b[0].geometry.location):alert("Location change failed because: "+c)})};var n=function(b){void 0==b&&(b=a.map.getCenter()),g=new google.maps.Marker({position:b,icon:j}),g.setMap(a.map)},o=function(b,c){a.map=new google.maps.Map(document.getElementById("map"),{center:b,zoom:c,disableDoubleClickZoom:!0}),e=new google.maps.InfoWindow,a.map.addListener("dblclick",function(b){g&&g.setMap(null),n(b.latLng),a.clickedPosition=b.latLng})};a.userfind=function(){function b(a,b,c){b.setPosition(c),b.setContent(a?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation.")}o(i,12),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){a.userPosition={lat:b.coords.latitude,lng:b.coords.longitude};var c=new google.maps.Marker({position:a.userPosition,animation:google.maps.Animation.DROP,icon:k});c.setMap(a.map),a.map.setCenter(a.userPosition),a.map.setZoom(14)},function(){b(!0,infoWindow,a.map.getCenter())}):b(!1,infoWindow,a.map.getCenter()),a.$apply()},a.createMarker=function(b,c){var d,f,g=(b.geometry.location,b.vicinity),h=b.name;b.opening_hours&&b.opening_hours.open_now?(d="Open to play right now!",f="open"):b.opening_hours&&!b.opening_hours.open_now?(d="Closed now, but check back again!",f="closed"):(d="",f="unknown");var i=l[c],j=new google.maps.Marker({map:a.map,position:b.geometry.location,animation:google.maps.Animation.DROP,icon:i});j.addListener("click",function(){$("*[data-placeId] .sitename").css("font-weight","normal"),$("*[data-placeId="+b.place_id+"] .sitename").css("font-weight","bold"),e.setContent('<div class="infowindow-name">'+h+'</div><div class="infowindow-open '+f+'">'+d+'</div><div class="infowindow-vicinity">'+g+"</div"),e.open(a.map,this)}),m.push(j)},a.siteListClick=function(a){google.maps.event.trigger(m[a],"click")},a.populateList=function(b,d,e){function f(d,e){e==google.maps.places.PlacesServiceStatus.OK&&(a.sitesResults=d,a.$apply(),_.each(d,function(d,e){c.post("/siteinfo",d).then(function(b){d.checkins=b.data.checkins,a.sitesResults[e].reviews=b.data.siteReviews,a.sitesResults[e].events=b.data.events,a.sitesResults[e].numberRating=b.data.numberRating,a.sitesResults[e].averageRating=b.data.averageRating,console.log("name",a.sitesResults[e].name,"numberRating",a.sitesResults[e].numberRating)},function(a){console.error("database post error: ",a)}),a.createMarker(d,b)}))}a.currentRankByFlag=e,a.selectedSport=d,void 0!=b&&(a.currentKeyword=b),h=void 0==a.clickedPosition?a.map.getCenter():a.clickedPosition;var g={location:h,keyword:[b]};e?_.extend(g,{rankBy:google.maps.places.RankBy.DISTANCE}):_.extend(g,{radius:"2000"}),_.each(m,function(a){a.setMap(null)}),m=[],a.sitesResults=[];var i=new google.maps.places.PlacesService(a.map);i.nearbySearch(g,f)},a.createEvent=function(b,d,e){var f={};f.place_id=b.place_id,f.sitename=b.name,f.events={sport:a.selectedSport,date:e.date,numPlayers:e.numPlayers,time:e.times,place:b.name,comment:e.comment},a.sitesResults[d].events.push(f.events),console.log("events are here: ",a.sitesResults[d].events),c.post("/eventinfo",f).then(function(a){console.log("Reponse in $scope.createEvent ",a)},function(a){console.error("Failed in post eventinfo ",a)})},a.siteCheckin=function(a){c.post("/checkin",a).then(function(b){a.checkins=b.data.checkins,a.checkedin=!0},function(a){console.error("database post error: ",error)})},a.siteCheckout=function(a){c.post("/checkout",a).then(function(b){a.checkins=b.data.checkins,a.checkedin=!1},function(a){console.error("database post error: ",error)})},a.postReview=function(b,d,e,f){var g={};g.place_id=b,g.user=e,g.text=f,g.rating=a.rating,console.log("My rating is: ",a.rating),c.post("/postReview",g).then(function(b){a.sitesResults[d].reviews=b.data.siteReviews,a.sitesResults[d].numberRating=b.data.numberRating,a.sitesResults[d].averageRating=b.data.averageRating},function(a){console.error("error in post review",a)})},a.rate=function(b){a.rating=b}}]);